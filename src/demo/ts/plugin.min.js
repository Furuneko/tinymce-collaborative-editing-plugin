!function(){"use strict";var i=(e.prototype.onResize=function(){var s=this;this.cursors.forEach(function(e,t){var n=e.range,o=e.node,r=s.editor.getDoc().querySelector("#cursor-"+t),i=n.getBoundingClientRect();0===i.top?(r.style.top=o.offsetTop+"px",r.style.left="1em"):(r.style.top=s.editor.getDoc().children[0].scrollTop+i.top+"px",r.style.left=i.left+"px")}),this.selections.forEach(function(e,t){var n=e.range,o=e.user;s.deleteUserInteractions(o),s.moveSelection(Array.from(n.getClientRects()),o)})},e.prototype.updateContent=function(e){this.ioClient.emit("set_content",{username:this.myUser.name,content:this.editor.getContent()}),this.onResize()},e.prototype.setUser=function(e){for(var t=this;;){if("break"===function(){var n=t.getRandomColor(),o=!1;if(t.colors.forEach(function(e,t){n===e&&(o=!0)}),!o)return t.colors.set(e.name,n),"break"}())break}var n,o=document.createElement("div");o.id="container-"+this.hash(e.name),o.style.display="inline-flex",o.style.position="relative",o.style.cursor="pointer",o.style.width="35px",o.style.alignItems="center",o.addEventListener("mouseover",function(e){e.target.children[1].style.visibility="visible"}),o.addEventListener("mouseout",function(e){e.target.children[1].style.visibility="hidden"}),e.photoUrl&&0<e.photoUrl.length&&"undefined"!==e.photoUrl?((n=document.createElement("img")).id="avatar-"+e.name,n.src=e.photoUrl,n.style.height="38px",n.style.width="35px",n.style.borderRadius="35px",n.style.pointerEvents="none"):((n=document.createElement("div")).id="avatar-"+e.name,n.style.height="30px",n.style.width="30px",n.style.borderRadius="30px",n.style.backgroundColor=this.colors.get(e.name),n.style.pointerEvents="none",n.style.textAlign="center",n.style.color="white",n.style.opacity="70%",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.innerText=e.name.charAt(0)),o.appendChild(n);var r=document.createElement("span");r.id="text-"+e.name,r.textContent=e.name,r.style.visibility="hidden",r.style.position="absolute",r.style.pointerEvents="none",r.style.verticalAlign="center",r.style.backgroundColor=this.colors.get(e.name),r.style.opacity="85%",r.style.color="white",r.style.fontSize="9px",r.style.paddingTop="9px",r.style.paddingBottom="9px",r.style.width=7*e.name.length+"px",r.style.textAlign="center",r.style.left="35px",r.style.borderRadius="5px",r.style.zIndex="10",o.appendChild(r),document.querySelector(this.editor.getParam("selector")).parentElement.querySelector("#user-container").appendChild(o)},e.prototype.onListen=function(e,t){var n=this.editor.getDoc().getSelection().getRangeAt(0);Object.defineProperties(n,{startOffset:{value:n.startOffset,enumerable:!0},endOffset:{value:n.endOffset,enumerable:!0}});for(var o=n.startContainer;"tinymce"!==o.parentElement.id;)o=o.parentElement;for(var r=o.previousSibling,i=0;null!==r;)i++,r=r.previousSibling;for(var s=n.endContainer;"tinymce"!==s.parentElement.id;)s=s.parentElement;for(var l=0,r=s.previousSibling;null!==r;)l++,r=r.previousSibling;this.deleteUserInteractions(t),n.startOffset===n.endOffset?this.ioClient.emit("set_cursor",JSON.stringify({range:n,user:t,nodeIndex:i,content:n.startContainer.textContent})):this.ioClient.emit("set_selection",JSON.stringify({range:n,startNodeIndex:i,endNodeIndex:l,user:t,startContent:n.startContainer.textContent,endContent:n.endContainer.textContent}))},e.prototype.findTextNode=function(e,t){var n;if(-1<e.textContent.trim().indexOf(t.trim())&&0===e.childNodes.length)return e;for(var o=0,r=Array.from(e.childNodes);o<r.length;o++){var i=r[o];if(-1<i.textContent.trim().indexOf(t.trim())&&0===i.childNodes.length)return i;if(n=this.findTextNode(i,t))return n}return n},e.prototype.removeUser=function(e){this.deleteUserInteractions(e),document.querySelector(this.editor.getParam("selector")).parentElement.querySelector("#user-container").querySelector("#container-"+this.hash(e.name)).remove()},e.prototype.deleteUserInteractions=function(e){var t=this.editor.getDoc().querySelector("#cursor-"+this.hash(e.name));t&&t.remove();var n=this.editor.getDoc().querySelectorAll("#selection-"+this.hash(e.name));n&&0<n.length&&n.forEach(function(e){e.remove()})},e.prototype.moveCursor=function(e,t,n){var o=this.hash(t.name),r=e.getBoundingClientRect(),i="cursor-"+o,s=document.createElement("div");s.id=i,s.style.position="absolute",s.style.zIndex="-1",s.style.position="block";var l=document.createElement("div");l.style.backgroundColor=this.colors.get(t.name),l.style.opacity="60%",l.style.width="2.5px",l.style.height=r.height?r.height+"px":"1em",l.style.position="relative";var a=document.createElement("span");a.style.backgroundColor=this.colors.get(t.name),a.style.color="white",a.style.fontSize="10px",a.style.height="12px",a.textContent=t.name,a.style.position="absolute",a.style.top="-12px",l.appendChild(a),s.appendChild(l),0===r.top?(s.style.top=n.offsetTop+"px",s.style.left="1em"):(s.style.top=this.editor.getDoc().children[0].scrollTop+r.top+"px",s.style.left=r.left+"px");var c=this.editor.getDoc().body;c.parentElement.insertBefore(s,c),this.cursors.set(o,{range:e,node:n}),this.selections.delete(o)},e.prototype.moveSelection=function(e,t){for(var n=this.editor.getDoc().body,o="selection-"+this.hash(t.name),r=0;r<e.length;r++){var i,s=document.createElement("span");s.id=o,s.style.backgroundColor=this.colors.get(t.name),s.style.opacity="50%",s.style.position="absolute",s.style.width=e[r].width+"px",s.style.height=e[r].height+"px",s.style.top=e[r].y+this.editor.getBody().parentElement.scrollTop+"px",s.style.left=e[r].x+"px",s.style.zIndex="-1",0===r&&((i=document.createElement("span")).style.backgroundColor=this.colors.get(t.name),i.style.color="white",i.style.fontSize="10px",i.style.height="14px",i.textContent=t.name,i.style.position="absolute",i.style.top="-14px",s.appendChild(i)),n.parentElement.insertBefore(s,n)}this.cursors.delete(this.hash(t.name))},e.prototype.hash=function(e){var t=0;if(0===e.length)return t;for(var n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n);t&=t}return t},e.prototype.getRandomColor=function(){for(var e="#",t=0;t<6;t++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e},e);function e(e,c){var d=this;this.editor=e,this.cursors=new Map,this.selections=new Map,this.colors=new Map,this.myUser=c,this.io=require("socket.io-client"),this.ioClient=this.io.connect(c.socketUrl,{query:"name="+c.name+"&photoUrl="+c.photoUrl}),this.ioClient.on("update_clients",function(e){new Map(e).forEach(function(e,t){c.name!==e.name&&d.setUser(e)})}),this.ioClient.on("delete_client",function(e){d.removeUser(e)}),this.ioClient.on("update_cursor",function(e){var t,n,o,r,i=JSON.parse(e);i.user.name!==d.myUser.name&&(d.deleteUserInteractions(i.user),t=new Range,n=d.editor.getDoc().querySelector(".mce-content-body").children[i.nodeIndex],o=d.findTextNode(n,i.content),r=0,i.range.endOffset>o.textContent.length&&r++,t.setStart(o,i.range.startOffset-r),t.setEnd(o,i.range.endOffset-r),d.moveCursor(t,i.user,n))}),this.ioClient.on("update_selection",function(e){var t,n,o,r,i,s,l,a=JSON.parse(e);a.user.name!==d.myUser.name&&(d.deleteUserInteractions(a.user),t=new Range,n=d.editor.getDoc().querySelector(".mce-content-body").children[a.startNodeIndex],o=d.editor.getDoc().querySelector(".mce-content-body").children[a.endNodeIndex],r=d.findTextNode(n,a.startContent),i=(i=d.findTextNode(o,a.endContent))||r,s=0,a.range.startOffset>r.textContent.length&&s++,l=0,a.range.endOffset>i.textContent.length&&l++,t.setStart(r,a.range.startOffset-s),t.setEnd(i,a.range.endOffset-l),d.selections.set(d.hash(c.name),{range:t,user:a.user}),d.moveSelection(Array.from(t.getClientRects()),a.user))}),this.ioClient.on("update_content",function(e){e.username!==d.myUser.name&&d.editor.setContent(e.content)})}var s=new Map;tinymce.create("tinymce.plugins.Budwriter",{Budwriter:function(r,e){r.on("Load",function(){var e=document.querySelector(r.getParam("selector")),t=document.createElement("div");t.id="user-container",t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="10px",e.parentElement.insertBefore(t,e);var n=JSON.parse(JSON.stringify(r.getParam("budwriter"))),o=new i(r,n);s.set(r.getParam("selector"),o),o.setUser(n),window.onresize=function(e){o.onResize()}}),r.on("click",function(e){var t=JSON.parse(JSON.stringify(r.getParam("budwriter")));s.get(r.getParam("selector")).onListen(e,t)}),r.on("NodeChange",function(e){var t=s.get(r.getParam("selector")),n=JSON.parse(JSON.stringify(r.getParam("budwriter")));t&&(t.updateContent(e),t.onListen(e,n))}),r.on("input",function(e){var t=s.get(r.getParam("selector")),n=JSON.parse(JSON.stringify(r.getParam("budwriter")));t&&(t.updateContent(e),t.onListen(e,n))})}}),tinymce.PluginManager.add("budwriter",tinymce.plugins.Budwriter)}();